"use client";
import React, { useEffect, useState } from "react";
import CardDataStats from "../CardDataStats";
import Link from "next/link";
import { getCookiesValue } from "@/utils/jwt-auth";
import supabase from "@/utils/supabase";

const ECommerce = () => {
  const [isShowCategories, setIsShowCategories] = useState<boolean>(false);
  const [isDataLoading, setIsDataLoading] = useState<boolean>(true);
  const [categoriesCount, setCategoriesCount] = useState(0);
  const [menusCount, setMenusCount] = useState(0);
  const [dishesCount, setDishesCount] = useState(0);

  useEffect(() => {
    const fetchCount = async () => {
      const user = await getCookiesValue("login-info");
      try {
        if (user.split("/")[1] == "super-admin") {
          setIsShowCategories(true);

          const { data, error: categoriesError } = await supabase
            .from("categories")
            .select("id")
            .eq("restaurant_id", 0);

          if (categoriesError) throw categoriesError;

          setCategoriesCount(data.length);
        } else {
          const { data, error: menusError } = await supabase
            .from("menus")
            .select("id")
            .eq("restaurant_id", user.split("/")[2])
            .neq("restaurant_id", 0);

          if (menusError) throw menusError;

          setMenusCount(data.length);

          let count: number = 0;
          const { data: menus, error: dishesError } = await supabase
            .from("menus")
            .select(`id, dishes(id)`)
            .eq("restaurant_id", user.split("/")[2])
            .neq("restaurant_id", 0);

          if (dishesError) throw dishesError;

          menus.map((menu) => {
            count = count + menu.dishes.length;
          });

          setDishesCount(count);
        }
      } catch (error) {
        console.error("Error while counting dishes : ", error);
      } finally {
        setIsDataLoading(false);
      }
    };

    fetchCount();
  }, []);

  return (
    <>
      <div className="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6 xl:grid-cols-4 2xl:gap-7.5">
        <Link
          href="/categories"
          className={`${isShowCategories ? "block" : "hidden"}`}
        >
          <CardDataStats
            title={categoriesCount > 1 ? "Categories" : "Category"}
            total={categoriesCount}
            rate="0.43%"
            levelUp
            quote="Crafted with love, served with perfection."
            isLoading={isDataLoading}
          >
            <svg
              className="fill-primary"
              width="25"
              height="30"
              viewBox="0 0 18 18"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g clipPath="url(#clip0_130_9807)">
                <path
                  d="M15.7501 0.55835H2.2501C1.29385 0.55835 0.506348 1.34585 0.506348 2.3021V7.53335C0.506348 8.4896 1.29385 9.2771 2.2501 9.2771H15.7501C16.7063 9.2771 17.4938 8.4896 17.4938 7.53335V2.3021C17.4938 1.34585 16.7063 0.55835 15.7501 0.55835ZM16.2563 7.53335C16.2563 7.8146 16.0313 8.0396 15.7501 8.0396H2.2501C1.96885 8.0396 1.74385 7.8146 1.74385 7.53335V2.3021C1.74385 2.02085 1.96885 1.79585 2.2501 1.79585H15.7501C16.0313 1.79585 16.2563 2.02085 16.2563 2.3021V7.53335Z"
                  fill=""
                />
                <path
                  d="M6.13135 10.9646H2.2501C1.29385 10.9646 0.506348 11.7521 0.506348 12.7083V15.8021C0.506348 16.7583 1.29385 17.5458 2.2501 17.5458H6.13135C7.0876 17.5458 7.8751 16.7583 7.8751 15.8021V12.7083C7.90322 11.7521 7.11572 10.9646 6.13135 10.9646ZM6.6376 15.8021C6.6376 16.0833 6.4126 16.3083 6.13135 16.3083H2.2501C1.96885 16.3083 1.74385 16.0833 1.74385 15.8021V12.7083C1.74385 12.4271 1.96885 12.2021 2.2501 12.2021H6.13135C6.4126 12.2021 6.6376 12.4271 6.6376 12.7083V15.8021Z"
                  fill=""
                />
                <path
                  d="M15.75 10.9646H11.8688C10.9125 10.9646 10.125 11.7521 10.125 12.7083V15.8021C10.125 16.7583 10.9125 17.5458 11.8688 17.5458H15.75C16.7063 17.5458 17.4938 16.7583 17.4938 15.8021V12.7083C17.4938 11.7521 16.7063 10.9646 15.75 10.9646ZM16.2562 15.8021C16.2562 16.0833 16.0312 16.3083 15.75 16.3083H11.8688C11.5875 16.3083 11.3625 16.0833 11.3625 15.8021V12.7083C11.3625 12.4271 11.5875 12.2021 11.8688 12.2021H15.75C16.0312 12.2021 16.2562 12.4271 16.2562 12.7083V15.8021Z"
                  fill=""
                />
              </g>
              <defs>
                <clipPath id="clip0_130_9807">
                  <rect
                    width="18"
                    height="18"
                    fill="white"
                    transform="translate(0 0.052124)"
                  />
                </clipPath>
              </defs>
            </svg>
          </CardDataStats>
        </Link>
        <Link
          href="/menus"
          className={`${isShowCategories ? "hidden" : "block"}`}
        >
          <CardDataStats
            title={menusCount > 1 ? "Menus" : "Menu"}
            total={menusCount}
            rate="0.43%"
            levelUp
            quote="Crafted with love, served with perfection."
            isLoading={isDataLoading}
          >
            <svg
              className="fill-primary"
              xmlns="http://www.w3.org/2000/svg"
              height="25"
              width="25"
              version="1.1"
              id="_x32_"
              viewBox="0 0 512 512"
            >
              <g>
                <path d="M257.783,144.629v60.21c0,3.854-3.271,6.959-7.308,6.959h-1.948c-4.036,0-7.29-3.105-7.29-6.959V144.35   c0-9.916-7.011-12.882-13.708-12.882c-6.715,0-13.709,2.966-13.709,12.882v60.489c0,3.854-3.288,6.959-7.306,6.959h-1.948   c-4.019,0-7.307-3.105-7.307-6.959v-60.21c0-17.763-26.53-17.162-26.53,0.2c0,20.79,0,57.497,0,57.497   c-0.121,31.924,7.863,40.222,21.068,50.164c10.647,8.012,19.746,12.605,19.746,32.498v127.998h31.975V284.988   c0-19.893,9.081-24.486,19.728-32.498c13.205-9.942,21.19-18.24,21.068-50.164c0,0,0-36.708,0-57.497   C284.314,127.467,257.783,126.866,257.783,144.629z" />
                <path d="M344.68,150.622c-6.802,18.172-19.536,62.568-19.536,85.115c-1.775,54.235,27.452,25.165,28.183,67.639   v109.966h31.819l0.157,0.392c0,0,0-0.166,0-0.392c0-5.106,0-65.943,0-128.006c0-61.393,0-123.926,0-134.713   C385.303,128.467,355.241,122.361,344.68,150.622z" />
                <path d="M475.332,35.481c-4.419-10.448-11.778-19.285-21.05-25.548c-4.627-3.132-9.742-5.61-15.222-7.315   C433.579,0.913,427.768,0,421.766,0H117.111h-4.888h-21.99c-8.002,0-15.692,1.626-22.651,4.567   C57.126,9.002,48.289,16.344,42.026,25.608c-3.132,4.636-5.62,9.751-7.324,15.23c-1.705,5.463-2.609,11.282-2.609,17.258v395.807   c0,7.976,1.618,15.657,4.575,22.615c4.419,10.448,11.778,19.285,21.034,25.548c4.645,3.131,9.776,5.618,15.239,7.315   C78.42,511.087,84.231,512,90.233,512h21.99h4.888h304.655c7.985,0,15.675-1.626,22.633-4.567   c10.456-4.428,19.311-11.769,25.556-21.042c3.131-4.627,5.637-9.751,7.324-15.222c1.723-5.463,2.628-11.282,2.628-17.266V58.096   C479.907,50.129,478.272,42.439,475.332,35.481z M108.186,480.998H90.233c-3.81-0.008-7.341-0.756-10.577-2.122   c-4.837-2.053-9.012-5.506-11.952-9.847c-1.461-2.166-2.61-4.532-3.392-7.072c-0.783-2.531-1.218-5.228-1.218-8.054V58.096   c0-3.775,0.766-7.298,2.122-10.534c2.053-4.828,5.498-9.002,9.847-11.934c2.174-1.462,4.541-2.619,7.08-3.41   c2.54-0.783,5.237-1.21,8.09-1.218h17.954V480.998z M448.888,453.904c0,3.775-0.747,7.298-2.105,10.534   c-2.053,4.836-5.515,9.002-9.847,11.943c-2.174,1.462-4.558,2.61-7.08,3.401c-2.557,0.783-5.236,1.21-8.089,1.218H126.036V31.001   h295.731c3.792,0.009,7.324,0.766,10.56,2.132c4.853,2.044,9.028,5.506,11.952,9.838c1.461,2.166,2.627,4.541,3.41,7.071   c0.783,2.54,1.2,5.22,1.2,8.055V453.904z" />
              </g>
            </svg>
          </CardDataStats>
        </Link>
        <Link
          href="/dishes"
          className={`${isShowCategories ? "hidden" : "block"}`}
        >
          <CardDataStats
            title={dishesCount > 1 ? "Dishes" : "Dish"}
            total={dishesCount}
            rate="4.35%"
            levelUp
            quote="Sensational dishes, unforgettable memories."
            isLoading={isDataLoading}
          >
            <svg
              className="fill-primary"
              xmlns="http://www.w3.org/2000/svg"
              height="30"
              width="30"
              version="1.1"
              id="Capa_1"
              viewBox="0 0 56.999 56.999"
            >
              <g>
                <path d="M56.784,40.046C56.452,39.4,55.795,39,55.069,39h-1.095c-0.464-12.195-9.362-22.26-21.017-24.52   C32.974,14.319,33,14.159,33,14c0-2.757-2.243-5-5-5s-5,2.243-5,5c0,0.159,0.025,0.32,0.043,0.48   C11.387,16.739,2.489,26.805,2.025,39H1.93c-0.726,0-1.383,0.4-1.715,1.046s-0.276,1.413,0.146,2.004l2.26,3.164   C3.867,46.959,5.891,48,8.034,48h40.932c2.143,0,4.167-1.041,5.413-2.786l2.261-3.164C57.061,41.459,57.116,40.691,56.784,40.046z    M25.006,14.172C25.002,14.114,25,14.056,25,14c0-1.654,1.346-3,3-3s3,1.346,3,3c0,0.057-0.002,0.114-0.006,0.172   c-0.047-0.005-0.094-0.007-0.14-0.012c-0.344-0.038-0.69-0.065-1.038-0.089c-0.128-0.009-0.255-0.022-0.383-0.029   C28.957,14.015,28.48,14,28,14s-0.958,0.015-1.432,0.041c-0.128,0.007-0.255,0.02-0.383,0.029   c-0.348,0.024-0.694,0.052-1.038,0.089C25.1,14.165,25.053,14.166,25.006,14.172z M24.406,16.269   c0.535-0.08,1.075-0.138,1.615-0.182c0.11-0.009,0.22-0.017,0.33-0.024c1.098-0.074,2.201-0.074,3.299,0   c0.11,0.008,0.22,0.016,0.33,0.024c0.54,0.044,1.079,0.102,1.615,0.182C42.806,17.96,51.503,27.437,51.979,39H4.02   C4.497,27.437,13.193,17.96,24.406,16.269z M52.751,44.051C51.879,45.271,50.464,46,48.965,46H8.034   c-1.499,0-2.914-0.729-3.786-1.948L2.068,41H54h0.931L52.751,44.051z" />
                <path d="M27.986,18c-1.643,0-3.278,0.181-4.86,0.537c-0.539,0.121-0.877,0.656-0.756,1.195c0.105,0.465,0.518,0.78,0.975,0.78   c0.073,0,0.147-0.008,0.221-0.024C25.004,20.164,26.491,20,27.986,20c0.004,0,0.008,0,0.013,0h0c0.552,0,1-0.447,1-0.999   C29,18.444,28.556,17.981,27.986,18z" />
                <path d="M17.15,20.899C11.946,23.982,8.158,29.56,7.016,35.82c-0.099,0.544,0.261,1.064,0.805,1.163   C7.881,36.995,7.941,37,8.001,37c0.474,0,0.895-0.338,0.983-0.82c1.039-5.698,4.473-10.768,9.186-13.56   c0.475-0.281,0.632-0.895,0.351-1.37C18.238,20.775,17.626,20.618,17.15,20.899z" />
              </g>
            </svg>
          </CardDataStats>
        </Link>
      </div>
    </>
  );
};

export default ECommerce;
